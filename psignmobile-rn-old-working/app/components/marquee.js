"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
/**
 * @flow
 */
const react_1 = require("react");
const react_native_1 = require("react-native");
// import  { StyleObj } from '../../node_modules/react-native/Libraries/StyleSheet/StyleSheetTypes';
const { UIManager } = react_native_1.NativeModules;
class MarqueeText extends react_1.PureComponent {
    constructor(props) {
        super(props);
        this.animatedValue = new react_native_1.Animated.Value(0);
        this.contentFits = false;
        this.distance = null;
        this.textRef = null;
        this.containerRef = null;
        this.state = {
            animating: false
        };
        this.invalidateMetrics();
    }
    componentDidMount() {
        const { marqueeDelay } = this.props;
        if (this.props.marqueeOnStart) {
            this.startAnimation(marqueeDelay);
        }
    }
    componentWillReceiveProps(nextProps) {
        if (this.props.children !== nextProps.children) {
            this.invalidateMetrics();
            this.resetAnimation();
        }
    }
    componentWillUnmount() {
        if (this.state.animating) {
            this.stopAnimation();
        }
        this.clearTimeout();
    }
    startAnimation(timeDelay) {
        if (this.state.animating) {
            return;
        }
        this.start(timeDelay);
    }
    stopAnimation() {
        this.stop();
    }
    /**
     * Resets the marquee and restarts it after `marqueeDelay` millisecons.
     */
    resetAnimation() {
        const marqueeResetDelay = Math.max(100, this.props.marqueeResetDelay);
        this.animatedValue.setValue(0);
        this.setState({ animating: false }, () => {
            this.startAnimation(marqueeResetDelay);
        });
    }
    start(timeDelay) {
        const { duration, loop, onMarqueeComplete, useNativeDriver } = this.props;
        const callback = () => {
            this.setState({ animating: true });
            this.setTimeout(() => {
                this.calculateMetrics();
                if (!this.contentFits) {
                    react_native_1.Animated.timing(this.animatedValue, {
                        toValue: -this.distance,
                        duration: duration,
                        useNativeDriver
                    }).start(({ finished }) => {
                        if (finished) {
                            if (loop) {
                                this.resetAnimation();
                            }
                            else {
                                this.stop();
                                onMarqueeComplete();
                            }
                        }
                    });
                }
            }, 100);
        };
        this.setTimeout(callback, timeDelay);
    }
    stop() {
        this.animatedValue.setValue(0);
        this.setState({ animating: false });
    }
    shouldAnimate(distance) {
        return distance > 0;
    }
    calculateMetrics() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const measureWidth = node => new Promise(resolve => {
                    UIManager.measure(react_native_1.findNodeHandle(node), (x, y, w) => {
                        // console.log('Width: ' + w);
                        return resolve(w);
                    });
                });
                const [containerWidth, textWidth] = (yield Promise.all([
                    measureWidth(this.containerRef),
                    measureWidth(this.textRef)
                ]));
                this.distance = textWidth - containerWidth;
                this.contentFits = !this.shouldAnimate(this.distance);
                return [];
                // console.log(`distance: ${this.distance}, contentFits: ${this.contentFits}`);
            }
            catch (error) {
                console.warn(error);
            }
        });
    }
    invalidateMetrics() {
        // Null distance is the special value to allow recalculation
        this.distance = null;
        // Assume the marquee does not fit until calculations show otherwise
        this.contentFits = false;
    }
    /**
     * Clears the timer
     */
    clearTimeout() {
        if (this.timer) {
            clearTimeout(this.timer);
            this.timer = null;
            // console.log("Currently running timeout is cleared!!!");
        }
    }
    /**
     * Starts a new timer
     */
    setTimeout(fn, time = 0) {
        this.clearTimeout();
        this.timer = setTimeout(fn, time);
    }
    render() {
        const _a = this.props, { children, style } = _a, rest = tslib_1.__rest(_a, ["children", "style"]);
        const { animating } = this.state;
        const { width, height } = react_native_1.StyleSheet.flatten(style);
        return (<react_native_1.View style={[styles.container, { width, height }]}>
        <react_native_1.Text numberOfLines={1} {...rest} style={[style, { opacity: animating ? 0 : 1 }]}>
          {children}
        </react_native_1.Text>
        <react_native_1.ScrollView ref={c => (this.containerRef = c)} style={react_native_1.StyleSheet.absoluteFillObject} display={animating ? "flex" : "none"} showsHorizontalScrollIndicator={false} horizontal scrollEnabled={false} onContentSizeChange={() => this.calculateMetrics()}>
          <react_native_1.Animated.Text ref={c => (this.textRef = c)} numberOfLines={1} {...rest} style={[
            style,
            { transform: [{ translateX: this.animatedValue }], width: null }
        ]}>
            {children}
          </react_native_1.Animated.Text>
        </react_native_1.ScrollView>
      </react_native_1.View>);
    }
}
MarqueeText.defaultProps = {
    style: {},
    duration: 3000,
    loop: false,
    marqueeOnStart: false,
    marqueeDelay: 0,
    marqueeResetDelay: 0,
    onMarqueeComplete: () => { },
    useNativeDriver: true
};
exports.default = MarqueeText;
const styles = react_native_1.StyleSheet.create({
    container: {
        overflow: "hidden"
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFycXVlZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1hcnF1ZWUudHN4Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBOztHQUVHO0FBQ0gsaUNBQTREO0FBQzVELCtDQVFzQjtBQUN0QixvR0FBb0c7QUFFcEcsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLDRCQUFhLENBQUM7QUF1RHBDLE1BQXFCLFdBQVksU0FBUSxxQkFBMkI7SUFzQmxFLFlBQVksS0FBWTtRQUN0QixLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFYixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksdUJBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7UUFDekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFFekIsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLFNBQVMsRUFBRSxLQUFLO1NBQ2pCLENBQUM7UUFFRixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQsaUJBQWlCO1FBQ2YsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDcEMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsRUFBRTtZQUM3QixJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ25DO0lBQ0gsQ0FBQztJQUVELHlCQUF5QixDQUFDLFNBQWdCO1FBQ3hDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEtBQUssU0FBUyxDQUFDLFFBQVEsRUFBRTtZQUM5QyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUN6QixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDdkI7SUFDSCxD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QUFDLHVCQUFRLENBQUMsSUFBSSxDQUNaLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQzdCLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUNqQixJQUFJLElBQUksQ0FBQyxDQUNULEtBQUssQ0FBQyxDQUFDO1lBQ0wsS0FBSztZQUNMLEVBQUUsU0FBUyxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtTQUNqRSxDQUFDLENBRUY7WUFBQSxDQUFDLFFBQVEsQ0FDWDtVQUFBLEVBQUUsdUJBQVEsQ0FBQyxJQUFJLENBQ2pCO1FBQUEsRUFBRSx5QkFBVSxDQUNkO01BQUEsRUFBRSxtQkFBSSxDQUFDLENBQ1IsQ0FBQztJQUNKLENBQUM7O0FBdk1NLHdCQUFZLEdBQUc7SUFDcEIsS0FBSyxFQUFFLEVBQUU7SUFDVCxRQUFRLEVBQUUsSUFBSTtJQUNkLElBQUksRUFBRSxLQUFLO0lBQ1gsY0FBYyxFQUFFLEtBQUs7SUFDckIsWUFBWSxFQUFFLENBQUM7SUFDZixpQkFBaUIsRUFBRSxDQUFDO0lBQ3BCLGlCQUFpQixFQUFFLEdBQUcsRUFBRSxHQUFFLENBQUM7SUFDM0IsZUFBZSxFQUFFLElBQUk7Q0FDdEIsQ0FBQztBQXBCSiw4QkFtTkM7QUFFRCxNQUFNLE1BQU0sR0FBRyx5QkFBVSxDQUFDLE1BQU0sQ0FBQztJQUMvQixTQUFTLEVBQUU7UUFDVCxRQUFRLEVBQUUsUUFBUTtLQUNuQjtDQUNGLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZsb3dcbiAqL1xuaW1wb3J0IFJlYWN0LCB7IFB1cmVDb21wb25lbnQsIENTU1Byb3BlcnRpZXMgfSBmcm9tIFwicmVhY3RcIjtcbmltcG9ydCB7XG4gIFN0eWxlU2hlZXQsXG4gIEFuaW1hdGVkLFxuICBUZXh0LFxuICBWaWV3LFxuICBTY3JvbGxWaWV3LFxuICBOYXRpdmVNb2R1bGVzLFxuICBmaW5kTm9kZUhhbmRsZVxufSBmcm9tIFwicmVhY3QtbmF0aXZlXCI7XG4vLyBpbXBvcnQgIHsgU3R5bGVPYmogfSBmcm9tICcuLi8uLi9ub2RlX21vZHVsZXMvcmVhY3QtbmF0aXZlL0xpYnJhcmllcy9TdHlsZVNoZWV0L1N0eWxlU2hlZXRUeXBlcyc7XG5cbmNvbnN0IHsgVUlNYW5hZ2VyIH0gPSBOYXRpdmVNb2R1bGVzO1xuXG50eXBlIFByb3BzID0ge1xuICAvKipcbiAgICogc3R5bGVcbiAgICovXG4gIHN0eWxlPzogQ1NTUHJvcGVydGllcztcbiAgLyoqXG4gICAqIE51bWJlciBvZiBtaWxsaXNlY29uZHMgdW50aWwgYW5pbWF0aW9uIGZpbmlzaGVzIGZyb20gc3RhcnQuXG4gICAqL1xuICBkdXJhdGlvbj86IG51bWJlcjtcbiAgLyoqXG4gICAqIFNldCB0aGlzIHRydWUgd2hlbiBhbmltYXRpb24gcmVwZWF0cy5cbiAgICovXG4gIGxvb3A/OiBib29sZWFuO1xuICAvKipcbiAgICogU2V0IHRoaXMgdHJ1ZSB3aGlsZSB3YWl0aW5nIGZvciBuZXcgZGF0YSBmcm9tIGEgcmVmcmVzaC5cbiAgICovXG4gIG1hcnF1ZWVPblN0YXJ0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIE51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCBiZWZvcmUgcmVzZXR0aW5nIHRoZSBtYXJxdWVlIHBvc2l0aW9uIGFmdGVyIGl0IGZpbmlzaGVzLlxuICAgKi9cbiAgbWFycXVlZVJlc2V0RGVsYXk/OiBudW1iZXI7XG4gIC8qKlxuICAgKiBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIHN0YXJ0aW5nIG9yIHJlc3RhcnRpbmcgbWFycXVlZS5cbiAgICovXG4gIG1hcnF1ZWVEZWxheT86IG51bWJlcjtcbiAgLyoqXG4gICAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciB3aGVuIHRoZSBtYXJxdWVlIGNvbXBsZXRlcyBpdHMgYW5pbWF0aW9uXG4gICAqL1xuICBvbk1hcnF1ZWVDb21wbGV0ZT86IEZ1bmN0aW9uO1xuICAvKipcbiAgICogVGV4dCBwYXNzZWRcbiAgICovXG4gIGNoaWxkcmVuOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBTZXQgdGhpcyB0cnVlbiBpZiB5b3Ugd2FudCB0byB1c2UgbmF0aXZlIGRyaXZlclxuICAgKi9cbiAgdXNlTmF0aXZlRHJpdmVyPzogYm9vbGVhbjtcbn07XG5cbnR5cGUgRGVmYXVsdFByb3BzID0ge1xuICBzdHlsZTogQ1NTUHJvcGVydGllcztcbiAgZHVyYXRpb246IG51bWJlcjtcbiAgbG9vcDogYm9vbGVhbjtcbiAgbWFycXVlZU9uU3RhcnQ6IGJvb2xlYW47XG4gIG1hcnF1ZWVSZXNldERlbGF5OiBudW1iZXI7XG4gIG1hcnF1ZWVEZWxheTogbnVtYmVyO1xuICBvbk1hcnF1ZWVDb21wbGV0ZTogRnVuY3Rpb247XG59O1xuXG50eXBlIFN0YXRlID0ge1xuICBhbmltYXRpbmc6IGJvb2xlYW47XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNYXJxdWVlVGV4dCBleHRlbmRzIFB1cmVDb21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XG4gIHByb3BzOiBQcm9wcztcbiAgc3RhdGU6IFN0YXRlO1xuXG4gIGRpc3RhbmNlPzogbnVtYmVyO1xuICBjb250ZW50Rml0czogYm9vbGVhbjtcbiAgYW5pbWF0ZWRWYWx1ZTogQW5pbWF0ZWQuVmFsdWU7XG4gIHRleHRSZWY/OiBUZXh0O1xuICBjb250YWluZXJSZWY/OiBTY3JvbGxWaWV3O1xuICB0aW1lcj86IG51bWJlcjtcblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIHN0eWxlOiB7fSxcbiAgICBkdXJhdGlvbjogMzAwMCxcbiAgICBsb29wOiBmYWxzZSxcbiAgICBtYXJxdWVlT25TdGFydDogZmFsc2UsXG4gICAgbWFycXVlZURlbGF5OiAwLFxuICAgIG1hcnF1ZWVSZXNldERlbGF5OiAwLFxuICAgIG9uTWFycXVlZUNvbXBsZXRlOiAoKSA9PiB7fSxcbiAgICB1c2VOYXRpdmVEcml2ZXI6IHRydWVcbiAgfTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG5cbiAgICB0aGlzLmFuaW1hdGVkVmFsdWUgPSBuZXcgQW5pbWF0ZWQuVmFsdWUoMCk7XG4gICAgdGhpcy5jb250ZW50Rml0cyA9IGZhbHNlO1xuICAgIHRoaXMuZGlzdGFuY2UgPSBudWxsO1xuICAgIHRoaXMudGV4dFJlZiA9IG51bGw7XG4gICAgdGhpcy5jb250YWluZXJSZWYgPSBudWxsO1xuXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGFuaW1hdGluZzogZmFsc2VcbiAgICB9O1xuXG4gICAgdGhpcy5pbnZhbGlkYXRlTWV0cmljcygpO1xuICB9XG5cbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XG4gICAgY29uc3QgeyBtYXJxdWVlRGVsYXkgfSA9IHRoaXMucHJvcHM7XG4gICAgaWYgKHRoaXMucHJvcHMubWFycXVlZU9uU3RhcnQpIHtcbiAgICAgIHRoaXMuc3RhcnRBbmltYXRpb24obWFycXVlZURlbGF5KTtcbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogUHJvcHMpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5jaGlsZHJlbiAhPT0gbmV4dFByb3BzLmNoaWxkcmVuKSB7XG4gICAgICB0aGlzLmludmFsaWRhdGVNZXRyaWNzKCk7XG4gICAgICB0aGlzLnJlc2V0QW5pbWF0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuYW5pbWF0aW5nKSB7XG4gICAgICB0aGlzLnN0b3BBbmltYXRpb24oKTtcbiAgICB9XG4gICAgdGhpcy5jbGVhclRpbWVvdXQoKTtcbiAgfVxuXG4gIHN0YXJ0QW5pbWF0aW9uKHRpbWVEZWxheTogbnVtYmVyKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUuYW5pbWF0aW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zdGFydCh0aW1lRGVsYXkpO1xuICB9XG5cbiAgc3RvcEFuaW1hdGlvbigpIHtcbiAgICB0aGlzLnN0b3AoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldHMgdGhlIG1hcnF1ZWUgYW5kIHJlc3RhcnRzIGl0IGFmdGVyIGBtYXJxdWVlRGVsYXlgIG1pbGxpc2Vjb25zLlxuICAgKi9cbiAgcmVzZXRBbmltYXRpb24oKSB7XG4gICAgY29uc3QgbWFycXVlZVJlc2V0RGVsYXkgPSBNYXRoLm1heCgxMDAsIHRoaXMucHJvcHMubWFycXVlZVJlc2V0RGVsYXkpO1xuICAgIHRoaXMuYW5pbWF0ZWRWYWx1ZS5zZXRWYWx1ZSgwKTtcbiAgICB0aGlzLnNldFN0YXRlKHsgYW5pbWF0aW5nOiBmYWxzZSB9LCAoKSA9PiB7XG4gICAgICB0aGlzLnN0YXJ0QW5pbWF0aW9uKG1hcnF1ZWVSZXNldERlbGF5KTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXJ0KHRpbWVEZWxheTogbnVtYmVyKSB7XG4gICAgY29uc3QgeyBkdXJhdGlvbiwgbG9vcCwgb25NYXJxdWVlQ29tcGxldGUsIHVzZU5hdGl2ZURyaXZlciB9ID0gdGhpcy5wcm9wcztcblxuICAgIGNvbnN0IGNhbGxiYWNrID0gKCkgPT4ge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGFuaW1hdGluZzogdHJ1ZSB9KTtcblxuICAgICAgdGhpcy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVNZXRyaWNzKCk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbnRlbnRGaXRzKSB7XG4gICAgICAgICAgQW5pbWF0ZWQudGltaW5nKHRoaXMuYW5pbWF0ZWRWYWx1ZSwge1xuICAgICAgICAgICAgdG9WYWx1ZTogLXRoaXMuZGlzdGFuY2UsXG4gICAgICAgICAgICBkdXJhdGlvbjogZHVyYXRpb24sXG4gICAgICAgICAgICB1c2VOYXRpdmVEcml2ZXJcbiAgICAgICAgICB9KS5zdGFydCgoeyBmaW5pc2hlZCB9KSA9PiB7XG4gICAgICAgICAgICBpZiAoZmluaXNoZWQpIHtcbiAgICAgICAgICAgICAgaWYgKGxvb3ApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlc2V0QW5pbWF0aW9uKCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgICAgICAgICAgb25NYXJxdWVlQ29tcGxldGUoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9LCAxMDApO1xuICAgIH07XG5cbiAgICB0aGlzLnNldFRpbWVvdXQoY2FsbGJhY2ssIHRpbWVEZWxheSk7XG4gIH1cblxuICBzdG9wKCkge1xuICAgIHRoaXMuYW5pbWF0ZWRWYWx1ZS5zZXRWYWx1ZSgwKTtcbiAgICB0aGlzLnNldFN0YXRlKHsgYW5pbWF0aW5nOiBmYWxzZSB9KTtcbiAgfVxuXG4gIHNob3VsZEFuaW1hdGUoZGlzdGFuY2U6IG51bWJlcikge1xuICAgIHJldHVybiBkaXN0YW5jZSA+IDA7XG4gIH1cblxuICBhc3luYyBjYWxjdWxhdGVNZXRyaWNzKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZWFzdXJlV2lkdGggPSBub2RlID0+XG4gICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgIFVJTWFuYWdlci5tZWFzdXJlKGZpbmROb2RlSGFuZGxlKG5vZGUpLCAoeCwgeSwgdykgPT4ge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1dpZHRoOiAnICsgdyk7XG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZSh3KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IFtjb250YWluZXJXaWR0aCwgdGV4dFdpZHRoXTogbnVtYmVyW10gPSAoYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICBtZWFzdXJlV2lkdGgodGhpcy5jb250YWluZXJSZWYpLFxuICAgICAgICBtZWFzdXJlV2lkdGgodGhpcy50ZXh0UmVmKVxuICAgICAgXSkpIGFzIGFueTtcblxuICAgICAgdGhpcy5kaXN0YW5jZSA9IHRleHRXaWR0aCAtIGNvbnRhaW5lcldpZHRoO1xuICAgICAgdGhpcy5jb250ZW50Rml0cyA9ICF0aGlzLnNob3VsZEFuaW1hdGUodGhpcy5kaXN0YW5jZSk7XG5cbiAgICAgIHJldHVybiBbXTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGBkaXN0YW5jZTogJHt0aGlzLmRpc3RhbmNlfSwgY29udGVudEZpdHM6ICR7dGhpcy5jb250ZW50Rml0c31gKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBpbnZhbGlkYXRlTWV0cmljcygpIHtcbiAgICAvLyBOdWxsIGRpc3RhbmNlIGlzIHRoZSBzcGVjaWFsIHZhbHVlIHRvIGFsbG93IHJlY2FsY3VsYXRpb25cbiAgICB0aGlzLmRpc3RhbmNlID0gbnVsbDtcbiAgICAvLyBBc3N1bWUgdGhlIG1hcnF1ZWUgZG9lcyBub3QgZml0IHVudGlsIGNhbGN1bGF0aW9ucyBzaG93IG90aGVyd2lzZVxuICAgIHRoaXMuY29udGVudEZpdHMgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhcnMgdGhlIHRpbWVyXG4gICAqL1xuICBjbGVhclRpbWVvdXQoKSB7XG4gICAgaWYgKHRoaXMudGltZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVyKTtcbiAgICAgIHRoaXMudGltZXIgPSBudWxsO1xuICAgICAgLy8gY29uc29sZS5sb2coXCJDdXJyZW50bHkgcnVubmluZyB0aW1lb3V0IGlzIGNsZWFyZWQhISFcIik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0cyBhIG5ldyB0aW1lclxuICAgKi9cbiAgc2V0VGltZW91dChmbjogRnVuY3Rpb24sIHRpbWU6IG51bWJlciA9IDApIHtcbiAgICB0aGlzLmNsZWFyVGltZW91dCgpO1xuICAgIHRoaXMudGltZXIgPSBzZXRUaW1lb3V0KGZuLCB0aW1lKTtcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGNoaWxkcmVuLCBzdHlsZSwgLi4ucmVzdCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCB7IGFuaW1hdGluZyB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IFN0eWxlU2hlZXQuZmxhdHRlbihzdHlsZSk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFZpZXcgc3R5bGU9e1tzdHlsZXMuY29udGFpbmVyLCB7IHdpZHRoLCBoZWlnaHQgfV19PlxuICAgICAgICA8VGV4dFxuICAgICAgICAgIG51bWJlck9mTGluZXM9ezF9XG4gICAgICAgICAgey4uLnJlc3R9XG4gICAgICAgICAgc3R5bGU9e1tzdHlsZSwgeyBvcGFjaXR5OiBhbmltYXRpbmcgPyAwIDogMSB9XX1cbiAgICAgICAgPlxuICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgPC9UZXh0PlxuICAgICAgICA8U2Nyb2xsVmlld1xuICAgICAgICAgIHJlZj17YyA9PiAodGhpcy5jb250YWluZXJSZWYgPSBjKX1cbiAgICAgICAgICBzdHlsZT17U3R5bGVTaGVldC5hYnNvbHV0ZUZpbGxPYmplY3R9XG4gICAgICAgICAgZGlzcGxheT17YW5pbWF0aW5nID8gXCJmbGV4XCIgOiBcIm5vbmVcIn1cbiAgICAgICAgICBzaG93c0hvcml6b250YWxTY3JvbGxJbmRpY2F0b3I9e2ZhbHNlfVxuICAgICAgICAgIGhvcml6b250YWxcbiAgICAgICAgICBzY3JvbGxFbmFibGVkPXtmYWxzZX1cbiAgICAgICAgICBvbkNvbnRlbnRTaXplQ2hhbmdlPXsoKSA9PiB0aGlzLmNhbGN1bGF0ZU1ldHJpY3MoKX1cbiAgICAgICAgPlxuICAgICAgICAgIDxBbmltYXRlZC5UZXh0XG4gICAgICAgICAgICByZWY9e2MgPT4gKHRoaXMudGV4dFJlZiA9IGMpfVxuICAgICAgICAgICAgbnVtYmVyT2ZMaW5lcz17MX1cbiAgICAgICAgICAgIHsuLi5yZXN0fVxuICAgICAgICAgICAgc3R5bGU9e1tcbiAgICAgICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgICAgIHsgdHJhbnNmb3JtOiBbeyB0cmFuc2xhdGVYOiB0aGlzLmFuaW1hdGVkVmFsdWUgfV0sIHdpZHRoOiBudWxsIH1cbiAgICAgICAgICAgIF19XG4gICAgICAgICAgPlxuICAgICAgICAgICAge2NoaWxkcmVufVxuICAgICAgICAgIDwvQW5pbWF0ZWQuVGV4dD5cbiAgICAgICAgPC9TY3JvbGxWaWV3PlxuICAgICAgPC9WaWV3PlxuICAgICk7XG4gIH1cbn1cblxuY29uc3Qgc3R5bGVzID0gU3R5bGVTaGVldC5jcmVhdGUoe1xuICBjb250YWluZXI6IHtcbiAgICBvdmVyZmxvdzogXCJoaWRkZW5cIlxuICB9XG59KTtcbiJdfQ==