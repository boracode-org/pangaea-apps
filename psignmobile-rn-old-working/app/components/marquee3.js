"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const React = require("react");
const react_native_1 = require("react-native");
const prop_types_1 = require("prop-types");
const _ = require("lodash");
function until(test, iterator, callback) {
    if (!test()) {
        iterator(err => {
            if (err) {
                return callback(err);
            }
            until(test, iterator, callback);
        });
    }
    else {
        callback();
    }
}
class Marquee extends React.Component {
    constructor() {
        super(...arguments);
        this.propTypes = {
            children: prop_types_1.default.string.isRequired,
            speed: prop_types_1.default.number,
            spaceRatio: prop_types_1.default.number
        };
        this.defaultProps = { speed: 30, spaceRatio: 0.5 };
        this.alpha = {};
        this.state = {
            left1: new react_native_1.Animated.Value(0),
            left2: new react_native_1.Animated.Value(0),
            list: this.props.children.split("")
        };
    }
    componentWillReceiveProps(nextProps) {
        if (this.props.children != nextProps.children) {
            this.animateEnable = false;
            //this.width = 0;
            this.state.left1.stopAnimation(() => {
                this.state.left2.stopAnimation(() => {
                    react_native_1.Animated.timing(this.state.left1, {
                        toValue: 0,
                        duration: 0
                    }).start(() => {
                        react_native_1.Animated.timing(this.state.left2, {
                            toValue: this.width,
                            duration: 0
                        }).start(() => {
                            this.setState({ list: nextProps.children.split("") });
                            if (!this.animateEnable) {
                                this.animateEnable = true;
                                until(() => this.width > 0, cb => setTimeout(cb, 100), () => this.startMoveFirstLabelHead());
                            }
                        });
                    });
                });
            });
        }
    }
    onLayout(i, e) {
        this.alpha[i] = e.nativeEvent.layout.width;
        if (_.size(this.alpha) === this.state.list.length) {
            this.twidth = _.sum(_.values(this.alpha));
            this.alpha = {};
            if (!this.animateEnable) {
                this.animateEnable = true;
                until(() => this.width > 0, cb => setTimeout(cb, 100), () => this.startMoveFirstLabelHead());
            }
        }
    }
    onLayoutContainer(e) {
        if (!this.width) {
            this.width = e.nativeEvent.layout.width;
            this.spaceWidth = this.props.spaceRatio * this.width;
            this.setState({ left1: new react_native_1.Animated.Value(0) });
            this.setState({ left2: new react_native_1.Animated.Value(this.width) });
        }
    }
    startMoveFirstLabelHead() {
        const { width, twidth, props } = this;
        const { speed } = props;
        return react_native_1.Animated.timing(this.state.left1, {
            toValue: -twidth + this.spaceWidth,
            duration: (twidth - this.spaceWidth) * speed,
            easing: react_native_1.Easing.linear,
            delay: 500
        }).start(() => {
            this.animateEnable &&
                react_native_1.Animated.parallel([
                    this.moveFirstLabelTail(),
                    this.moveSecondLabelHead()
                ]);
        });
    }
    moveFirstLabelHead() {
        const { width, twidth, props } = this;
        const { speed } = props;
        react_native_1.Animated.timing(this.state.left1, {
            toValue: -twidth + this.spaceWidth,
            duration: (twidth + this.spaceWidth) * speed,
            easing: react_native_1.Easing.linear
        }).start(() => {
            this.animateEnable &&
                react_native_1.Animated.parallel([
                    this.moveFirstLabelTail(),
                    this.moveSecondLabelHead()
                ]);
        });
    }
    moveFirstLabelTail() {
        const { width, twidth, props } = this;
        const { speed } = props;
        return react_native_1.Animated.timing(this.state.left1, {
            toValue: -twidth,
            duration: this.spaceWidth * speed,
            easing: react_native_1.Easing.linear
        }).start(() => {
            this.animateEnable &&
                this.setState({
                    left1: new react_native_1.Animated.Value(width)
                });
        });
    }
    moveSecondLabelHead() {
        const { width, twidth, props } = this;
        const { speed } = props;
        return react_native_1.Animated.timing(this.state.left2, {
            toValue: -twidth + this.spaceWidth,
            duration: (twidth + this.spaceWidth) * speed,
            easing: react_native_1.Easing.linear
        }).start(() => {
            this.animateEnable &&
                react_native_1.Animated.parallel([
                    this.moveFirstLabelHead(),
                    this.moveSecondLabelTail()
                ]);
        });
    }
    moveSecondLabelTail() {
        const { width, twidth, props } = this;
        const { speed } = props;
        return react_native_1.Animated.timing(this.state.left2, {
            toValue: -twidth,
            duration: this.spaceWidth * speed,
            easing: react_native_1.Easing.linear
        }).start(() => {
            this.animateEnable &&
                this.setState({
                    left2: new react_native_1.Animated.Value(twidth)
                });
        });
    }
    render() {
        const { left1, left2, list } = this.state;
        const s = react_native_1.StyleSheet.flatten(this.props.style);
        const textStyleKeys = [
            "color",
            "fontSize",
            "fontWeight",
            "letterSpacing",
            "fontStyle",
            "lineHeight",
            "fontFamily",
            "textDecorationLine"
        ];
        const textStyle = _.pick(s, textStyleKeys);
        const containerStyle = _.omit(s, textStyleKeys);
        return (<react_native_1.View style={[containerStyle, { flexDirection: "row" }]} onLayout={this.onLayoutContainer}>
        <react_native_1.Animated.View style={{ flexDirection: "row", left: left1 }}>
          {list.map((o, i) => (<react_native_1.Text key={i} onLayout={this.onLayout.bind(null, i)} style={textStyle}>
              {o}
            </react_native_1.Text>))}
        </react_native_1.Animated.View>
        <react_native_1.Animated.View style={{ flexDirection: "row", position: "absolute", left: left2 }}>
          {list.map((o, i) => (<react_native_1.Text key={i} style={textStyle}>
              {o}
            </react_native_1.Text>))}
        </react_native_1.Animated.View>
      </react_native_1.View>);
    }
}
exports.default = Marquee;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFycXVlZTMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtYXJxdWVlMy50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOztBQUViLCtCQUErQjtBQUMvQiwrQ0FBd0U7QUFDeEUsMkNBQW1DO0FBQ25DLDRCQUE0QjtBQUU1QixTQUFTLEtBQUssQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVE7SUFDckMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFO1FBQ1gsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2IsSUFBSSxHQUFHLEVBQUU7Z0JBQ1AsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDdEI7WUFDRCxLQUFLLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztLQUNKO1NBQU07UUFDTCxRQUFRLEVBQUUsQ0FBQztLQUNaO0FBQ0gsQ0FBQztBQUVELE1BQXFCLE9BQVEsU0FBUSxLQUFLLENBQUMsU0FBbUI7SUFBOUQ7O1FBS0UsY0FBUyxHQUFHO1lBQ1YsUUFBUSxFQUFFLG9CQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7WUFDckMsS0FBSyxFQUFFLG9CQUFTLENBQUMsTUFBTTtZQUN2QixVQUFVLEVBQUUsb0JBQVMsQ0FBQyxNQUFNO1NBQzdCLENBQUM7UUFDRixpQkFBWSxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDOUMsVUFBSyxHQUFHLEVBQUUsQ0FBQztRQUVYLFVBQUssR0FBRztZQUNOLEtBQUssRUFBRSxJQUFJLHVCQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUM1QixLQUFLLEVBQUUsSUFBSSx1QkFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDNUIsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENB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LENBQ2Y7UUFBQSxDQUFDLHVCQUFRLENBQUMsSUFBSSxDQUNaLEtBQUssQ0FBQyxDQUFDLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUVuRTtVQUFBLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQ2xCLENBQUMsbUJBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FDN0I7Y0FBQSxDQUFDLENBQUMsQ0FDSjtZQUFBLEVBQUUsbUJBQUksQ0FBQyxDQUNSLENBQUMsQ0FDSjtRQUFBLEVBQUUsdUJBQVEsQ0FBQyxJQUFJLENBQ2pCO01BQUEsRUFBRSxtQkFBSSxDQUFDLENBQ1IsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTVMRCwwQkE0TEMiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQgeyBTdHlsZVNoZWV0LCBWaWV3LCBUZXh0LCBBbmltYXRlZCwgRWFzaW5nIH0gZnJvbSBcInJlYWN0LW5hdGl2ZVwiO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tIFwicHJvcC10eXBlc1wiO1xuaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XG5cbmZ1bmN0aW9uIHVudGlsKHRlc3QsIGl0ZXJhdG9yLCBjYWxsYmFjaykge1xuICBpZiAoIXRlc3QoKSkge1xuICAgIGl0ZXJhdG9yKGVyciA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpO1xuICAgICAgfVxuICAgICAgdW50aWwodGVzdCwgaXRlcmF0b3IsIGNhbGxiYWNrKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjYWxsYmFjaygpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1hcnF1ZWUgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8YW55LCBhbnk+IHtcbiAgdHdpZHRoOiBhbnk7XG4gIHNwYWNlV2lkdGg6IG51bWJlcjtcbiAgd2lkdGg6IGFueTtcbiAgYW5pbWF0ZUVuYWJsZTogYm9vbGVhbjtcbiAgcHJvcFR5cGVzID0ge1xuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgc3BlZWQ6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgc3BhY2VSYXRpbzogUHJvcFR5cGVzLm51bWJlclxuICB9O1xuICBkZWZhdWx0UHJvcHMgPSB7IHNwZWVkOiAzMCwgc3BhY2VSYXRpbzogMC41IH07XG4gIGFscGhhID0ge307XG5cbiAgc3RhdGUgPSB7XG4gICAgbGVmdDE6IG5ldyBBbmltYXRlZC5WYWx1ZSgwKSxcbiAgICBsZWZ0MjogbmV3IEFuaW1hdGVkLlZhbHVlKDApLFxuICAgIGxpc3Q6IHRoaXMucHJvcHMuY2hpbGRyZW4uc3BsaXQoXCJcIilcbiAgfTtcblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wcykge1xuICAgIGlmICh0aGlzLnByb3BzLmNoaWxkcmVuICE9IG5leHRQcm9wcy5jaGlsZHJlbikge1xuICAgICAgdGhpcy5hbmltYXRlRW5hYmxlID0gZmFsc2U7XG4gICAgICAvL3RoaXMud2lkdGggPSAwO1xuICAgICAgdGhpcy5zdGF0ZS5sZWZ0MS5zdG9wQW5pbWF0aW9uKCgpID0+IHtcbiAgICAgICAgdGhpcy5zdGF0ZS5sZWZ0Mi5zdG9wQW5pbWF0aW9uKCgpID0+IHtcbiAgICAgICAgICBBbmltYXRlZC50aW1pbmcodGhpcy5zdGF0ZS5sZWZ0MSwge1xuICAgICAgICAgICAgdG9WYWx1ZTogMCxcbiAgICAgICAgICAgIGR1cmF0aW9uOiAwXG4gICAgICAgICAgfSkuc3RhcnQoKCkgPT4ge1xuICAgICAgICAgICAgQW5pbWF0ZWQudGltaW5nKHRoaXMuc3RhdGUubGVmdDIsIHtcbiAgICAgICAgICAgICAgdG9WYWx1ZTogdGhpcy53aWR0aCxcbiAgICAgICAgICAgICAgZHVyYXRpb246IDBcbiAgICAgICAgICAgIH0pLnN0YXJ0KCgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5zZXRTdGF0ZSh7IGxpc3Q6IG5leHRQcm9wcy5jaGlsZHJlbi5zcGxpdChcIlwiKSB9KTtcbiAgICAgICAgICAgICAgaWYgKCF0aGlzLmFuaW1hdGVFbmFibGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFuaW1hdGVFbmFibGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHVudGlsKFxuICAgICAgICAgICAgICAgICAgKCkgPT4gdGhpcy53aWR0aCA+IDAsXG4gICAgICAgICAgICAgICAgICBjYiA9PiBzZXRUaW1lb3V0KGNiLCAxMDApLFxuICAgICAgICAgICAgICAgICAgKCkgPT4gdGhpcy5zdGFydE1vdmVGaXJzdExhYmVsSGVhZCgpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIG9uTGF5b3V0KGksIGUpIHtcbiAgICB0aGlzLmFscGhhW2ldID0gZS5uYXRpdmVFdmVudC5sYXlvdXQud2lkdGg7XG4gICAgaWYgKF8uc2l6ZSh0aGlzLmFscGhhKSA9PT0gdGhpcy5zdGF0ZS5saXN0Lmxlbmd0aCkge1xuICAgICAgdGhpcy50d2lkdGggPSBfLnN1bShfLnZhbHVlcyh0aGlzLmFscGhhKSk7XG4gICAgICB0aGlzLmFscGhhID0ge307XG4gICAgICBpZiAoIXRoaXMuYW5pbWF0ZUVuYWJsZSkge1xuICAgICAgICB0aGlzLmFuaW1hdGVFbmFibGUgPSB0cnVlO1xuICAgICAgICB1bnRpbChcbiAgICAgICAgICAoKSA9PiB0aGlzLndpZHRoID4gMCxcbiAgICAgICAgICBjYiA9PiBzZXRUaW1lb3V0KGNiLCAxMDApLFxuICAgICAgICAgICgpID0+IHRoaXMuc3RhcnRNb3ZlRmlyc3RMYWJlbEhlYWQoKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBvbkxheW91dENvbnRhaW5lcihlKSB7XG4gICAgaWYgKCF0aGlzLndpZHRoKSB7XG4gICAgICB0aGlzLndpZHRoID0gZS5uYXRpdmVFdmVudC5sYXlvdXQud2lkdGg7XG4gICAgICB0aGlzLnNwYWNlV2lkdGggPSB0aGlzLnByb3BzLnNwYWNlUmF0aW8gKiB0aGlzLndpZHRoO1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7IGxlZnQxOiBuZXcgQW5pbWF0ZWQuVmFsdWUoMCkgfSk7XG4gICAgICB0aGlzLnNldFN0YXRlKHsgbGVmdDI6IG5ldyBBbmltYXRlZC5WYWx1ZSh0aGlzLndpZHRoKSB9KTtcbiAgICB9XG4gIH1cbiAgc3RhcnRNb3ZlRmlyc3RMYWJlbEhlYWQoKSB7XG4gICAgY29uc3QgeyB3aWR0aCwgdHdpZHRoLCBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHNwZWVkIH0gPSBwcm9wcztcbiAgICByZXR1cm4gQW5pbWF0ZWQudGltaW5nKHRoaXMuc3RhdGUubGVmdDEsIHtcbiAgICAgIHRvVmFsdWU6IC10d2lkdGggKyB0aGlzLnNwYWNlV2lkdGgsXG4gICAgICBkdXJhdGlvbjogKHR3aWR0aCAtIHRoaXMuc3BhY2VXaWR0aCkgKiBzcGVlZCxcbiAgICAgIGVhc2luZzogRWFzaW5nLmxpbmVhcixcbiAgICAgIGRlbGF5OiA1MDBcbiAgICB9KS5zdGFydCgoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGVFbmFibGUgJiZcbiAgICAgICAgQW5pbWF0ZWQucGFyYWxsZWwoW1xuICAgICAgICAgIHRoaXMubW92ZUZpcnN0TGFiZWxUYWlsKCksXG4gICAgICAgICAgdGhpcy5tb3ZlU2Vjb25kTGFiZWxIZWFkKClcbiAgICAgICAgXSBhcyBhbnkpO1xuICAgIH0pO1xuICB9XG4gIG1vdmVGaXJzdExhYmVsSGVhZCgpIHtcbiAgICBjb25zdCB7IHdpZHRoLCB0d2lkdGgsIHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3BlZWQgfSA9IHByb3BzO1xuICAgIEFuaW1hdGVkLnRpbWluZyh0aGlzLnN0YXRlLmxlZnQxLCB7XG4gICAgICB0b1ZhbHVlOiAtdHdpZHRoICsgdGhpcy5zcGFjZVdpZHRoLFxuICAgICAgZHVyYXRpb246ICh0d2lkdGggKyB0aGlzLnNwYWNlV2lkdGgpICogc3BlZWQsXG4gICAgICBlYXNpbmc6IEVhc2luZy5saW5lYXJcbiAgICB9KS5zdGFydCgoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGVFbmFibGUgJiZcbiAgICAgICAgQW5pbWF0ZWQucGFyYWxsZWwoW1xuICAgICAgICAgIHRoaXMubW92ZUZpcnN0TGFiZWxUYWlsKCksXG4gICAgICAgICAgdGhpcy5tb3ZlU2Vjb25kTGFiZWxIZWFkKClcbiAgICAgICAgXSBhcyBhbnkpO1xuICAgIH0pO1xuICB9XG4gIG1vdmVGaXJzdExhYmVsVGFpbCgpIHtcbiAgICBjb25zdCB7IHdpZHRoLCB0d2lkdGgsIHByb3BzIH0gPSB0aGlzO1xuICAgIGNvbnN0IHsgc3BlZWQgfSA9IHByb3BzO1xuICAgIHJldHVybiBBbmltYXRlZC50aW1pbmcodGhpcy5zdGF0ZS5sZWZ0MSwge1xuICAgICAgdG9WYWx1ZTogLXR3aWR0aCxcbiAgICAgIGR1cmF0aW9uOiB0aGlzLnNwYWNlV2lkdGggKiBzcGVlZCxcbiAgICAgIGVhc2luZzogRWFzaW5nLmxpbmVhclxuICAgIH0pLnN0YXJ0KCgpID0+IHtcbiAgICAgIHRoaXMuYW5pbWF0ZUVuYWJsZSAmJlxuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICBsZWZ0MTogbmV3IEFuaW1hdGVkLlZhbHVlKHdpZHRoKVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBtb3ZlU2Vjb25kTGFiZWxIZWFkKCkge1xuICAgIGNvbnN0IHsgd2lkdGgsIHR3aWR0aCwgcHJvcHMgfSA9IHRoaXM7XG4gICAgY29uc3QgeyBzcGVlZCB9ID0gcHJvcHM7XG4gICAgcmV0dXJuIEFuaW1hdGVkLnRpbWluZyh0aGlzLnN0YXRlLmxlZnQyLCB7XG4gICAgICB0b1ZhbHVlOiAtdHdpZHRoICsgdGhpcy5zcGFjZVdpZHRoLFxuICAgICAgZHVyYXRpb246ICh0d2lkdGggKyB0aGlzLnNwYWNlV2lkdGgpICogc3BlZWQsXG4gICAgICBlYXNpbmc6IEVhc2luZy5saW5lYXJcbiAgICB9KS5zdGFydCgoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGVFbmFibGUgJiZcbiAgICAgICAgQW5pbWF0ZWQucGFyYWxsZWwoW1xuICAgICAgICAgIHRoaXMubW92ZUZpcnN0TGFiZWxIZWFkKCksXG4gICAgICAgICAgdGhpcy5tb3ZlU2Vjb25kTGFiZWxUYWlsKClcbiAgICAgICAgXSBhcyBhbnkpO1xuICAgIH0pO1xuICB9XG4gIG1vdmVTZWNvbmRMYWJlbFRhaWwoKSB7XG4gICAgY29uc3QgeyB3aWR0aCwgdHdpZHRoLCBwcm9wcyB9ID0gdGhpcztcbiAgICBjb25zdCB7IHNwZWVkIH0gPSBwcm9wcztcbiAgICByZXR1cm4gQW5pbWF0ZWQudGltaW5nKHRoaXMuc3RhdGUubGVmdDIsIHtcbiAgICAgIHRvVmFsdWU6IC10d2lkdGgsXG4gICAgICBkdXJhdGlvbjogdGhpcy5zcGFjZVdpZHRoICogc3BlZWQsXG4gICAgICBlYXNpbmc6IEVhc2luZy5saW5lYXJcbiAgICB9KS5zdGFydCgoKSA9PiB7XG4gICAgICB0aGlzLmFuaW1hdGVFbmFibGUgJiZcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgbGVmdDI6IG5ldyBBbmltYXRlZC5WYWx1ZSh0d2lkdGgpXG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7IGxlZnQxLCBsZWZ0MiwgbGlzdCB9ID0gdGhpcy5zdGF0ZTtcbiAgICBjb25zdCBzID0gU3R5bGVTaGVldC5mbGF0dGVuKHRoaXMucHJvcHMuc3R5bGUpO1xuICAgIGNvbnN0IHRleHRTdHlsZUtleXMgPSBbXG4gICAgICBcImNvbG9yXCIsXG4gICAgICBcImZvbnRTaXplXCIsXG4gICAgICBcImZvbnRXZWlnaHRcIixcbiAgICAgIFwibGV0dGVyU3BhY2luZ1wiLFxuICAgICAgXCJmb250U3R5bGVcIixcbiAgICAgIFwibGluZUhlaWdodFwiLFxuICAgICAgXCJmb250RmFtaWx5XCIsXG4gICAgICBcInRleHREZWNvcmF0aW9uTGluZVwiXG4gICAgXTtcbiAgICBjb25zdCB0ZXh0U3R5bGUgPSBfLnBpY2socywgdGV4dFN0eWxlS2V5cyk7XG4gICAgY29uc3QgY29udGFpbmVyU3R5bGUgPSBfLm9taXQocywgdGV4dFN0eWxlS2V5cyk7XG4gICAgcmV0dXJuIChcbiAgICAgIDxWaWV3XG4gICAgICAgIHN0eWxlPXtbY29udGFpbmVyU3R5bGUsIHsgZmxleERpcmVjdGlvbjogXCJyb3dcIiB9XX1cbiAgICAgICAgb25MYXlvdXQ9e3RoaXMub25MYXlvdXRDb250YWluZXJ9XG4gICAgICA+XG4gICAgICAgIDxBbmltYXRlZC5WaWV3IHN0eWxlPXt7IGZsZXhEaXJlY3Rpb246IFwicm93XCIsIGxlZnQ6IGxlZnQxIH19PlxuICAgICAgICAgIHtsaXN0Lm1hcCgobywgaSkgPT4gKFxuICAgICAgICAgICAgPFRleHRcbiAgICAgICAgICAgICAga2V5PXtpfVxuICAgICAgICAgICAgICBvbkxheW91dD17dGhpcy5vbkxheW91dC5iaW5kKG51bGwsIGkpfVxuICAgICAgICAgICAgICBzdHlsZT17dGV4dFN0eWxlfVxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgICB7b31cbiAgICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgICApKX1cbiAgICAgICAgPC9BbmltYXRlZC5WaWV3PlxuICAgICAgICA8QW5pbWF0ZWQuVmlld1xuICAgICAgICAgIHN0eWxlPXt7IGZsZXhEaXJlY3Rpb246IFwicm93XCIsIHBvc2l0aW9uOiBcImFic29sdXRlXCIsIGxlZnQ6IGxlZnQyIH19XG4gICAgICAgID5cbiAgICAgICAgICB7bGlzdC5tYXAoKG8sIGkpID0+IChcbiAgICAgICAgICAgIDxUZXh0IGtleT17aX0gc3R5bGU9e3RleHRTdHlsZX0+XG4gICAgICAgICAgICAgIHtvfVxuICAgICAgICAgICAgPC9UZXh0PlxuICAgICAgICAgICkpfVxuICAgICAgICA8L0FuaW1hdGVkLlZpZXc+XG4gICAgICA8L1ZpZXc+XG4gICAgKTtcbiAgfVxufVxuIl19