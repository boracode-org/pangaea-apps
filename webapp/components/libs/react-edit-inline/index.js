"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const React = require("react");
const ReactDOM = require("react-dom");
const PropTypes = require("prop-types");
function selectInputText(element) {
    element.setSelectionRange(0, element.value.length);
}
class InlineEdit extends React.Component {
    constructor() {
        super(...arguments);
        this.state = {
            editing: this.props.editing,
            text: this.props.text,
            minLength: this.props.minLength,
            maxLength: this.props.maxLength,
        };
        this.startEditing = (e) => {
            if (this.props.stopPropagation) {
                e.stopPropagation();
            }
            this.setState({ editing: true, text: this.props.text });
        };
        this.finishEditing = () => {
            if (this.isInputValid(this.state.text) && this.props.text != this.state.text) {
                this.commitEditing();
            }
            else if (this.props.text === this.state.text || !this.isInputValid(this.state.text)) {
                this.cancelEditing();
            }
        };
        this.cancelEditing = () => {
            this.setState({ editing: false, text: this.props.text });
        };
        this.commitEditing = () => {
            this.setState({ editing: false, text: this.state.text });
            let newProp = {};
            newProp[this.props.paramName] = this.state.text;
            this.props.change(newProp);
        };
        this.clickWhenEditing = (e) => {
            if (this.props.stopPropagation) {
                e.stopPropagation();
            }
        };
        this.isInputValid = (text) => {
            return (text.length >= this.state.minLength && text.length <= this.state.maxLength);
        };
        this.keyDown = (event) => {
            if (event.keyCode === 13) {
                this.finishEditing();
            }
            else if (event.keyCode === 27) {
                this.cancelEditing();
            }
        };
        this.textChanged = (event) => {
            this.setState({
                text: event.target.value.trim()
            });
        };
    }
    componentWillMount() {
        this.isInputValid = this.props.validate || this.isInputValid;
        // Warn about deprecated elements
        if (this.props.element) {
            console.warn('`element` prop is deprecated: instead pass editingElement or staticElement to InlineEdit component');
        }
    }
    componentWillReceiveProps(nextProps) {
        const isTextChanged = (nextProps.text !== this.props.text);
        const isEditingChanged = (nextProps.editing !== this.props.editing);
        let nextState = {};
        if (isTextChanged) {
            nextState.text = nextProps.text;
        }
        if (isEditingChanged) {
            nextState.editing = nextProps.editing;
        }
        if (isTextChanged || isEditingChanged) {
            this.setState(nextState);
        }
    }
    componentDidUpdate(prevProps, prevState) {
        let inputElem = ReactDOM.findDOMNode(this.refs.input);
        if (this.state.editing && !prevState.editing) {
            inputElem.focus();
            selectInputText(inputElem);
        }
        else if (this.state.editing && prevProps.text != this.props.text) {
            this.finishEditing();
        }
    }
    render() {
        if (this.props.isDisabled) {
            const Element = this.props.element || this.props.staticElement;
            return React.createElement(Element, { className: this.props.className, style: this.props.style }, this.state.text || this.props.placeholder);
        }
        else if (!this.state.editing) {
            const Element = this.props.element || this.props.staticElement;
            return React.createElement(Element, { className: this.props.className, onClick: this.startEditing, tabIndex: this.props.tabIndex, style: this.props.style }, this.state.text || this.props.placeholder);
        }
        else {
            const Element = this.props.element || this.props.editingElement;
            return React.createElement(Element, { onClick: this.clickWhenEditing, onKeyDown: this.keyDown, onBlur: this.finishEditing, className: this.props.activeClassName, placeholder: this.props.placeholder, defaultValue: this.state.text, onChange: this.textChanged, style: this.props.style, ref: "input" });
        }
    }
}
InlineEdit.propTypes = {
    text: PropTypes.string.isRequired,
    paramName: PropTypes.string.isRequired,
    change: PropTypes.func.isRequired,
    placeholder: PropTypes.string,
    className: PropTypes.string,
    activeClassName: PropTypes.string,
    minLength: PropTypes.number,
    maxLength: PropTypes.number,
    validate: PropTypes.func,
    style: PropTypes.object,
    editingElement: PropTypes.string,
    staticElement: PropTypes.string,
    tabIndex: PropTypes.number,
    isDisabled: PropTypes.bool,
    editing: PropTypes.bool
};
InlineEdit.defaultProps = {
    minLength: 1,
    maxLength: 256,
    editingElement: 'input',
    staticElement: 'span',
    tabIndex: 0,
    isDisabled: false,
    editing: false
};
exports.default = InlineEdit;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFBK0I7QUFDL0Isc0NBQXNDO0FBQ3RDLHdDQUF3QztBQUd4Qyx5QkFBeUIsT0FBTztJQUM1QixPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdkQsQ0FBQztBQUVELGdCQUFnQyxTQUFRLEtBQUssQ0FBQyxTQUFrQjtJQUFoRTs7UUE2QkksVUFBSyxHQUFHO1lBQ0osT0FBTyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTztZQUMzQixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQ3JCLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVM7WUFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUztTQUNsQyxDQUFDO1FBbUNGLGlCQUFZLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNqQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7Z0JBQzdCLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQTtZQUN2QixDQUFDO1lBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUMxRCxDQUFDLENBQUM7UUFFRixrQkFBYSxHQUFHLEdBQUcsRUFBRTtZQUNqQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDO2dCQUMx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QUUsTUFBTTtJQUNyQixRQUFRLEVBQUUsQ0FBQztJQUNYLFVBQVUsRUFBRSxLQUFLO0lBQ2pCLE9BQU8sRUFBRSxLQUFLO0NBQ2pCLENBQUM7QUEzQk4sNkJBc0pDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0ICogYXMgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcbmltcG9ydCAqIGFzIFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcblxuXG5mdW5jdGlvbiBzZWxlY3RJbnB1dFRleHQoZWxlbWVudCkge1xuICAgIGVsZW1lbnQuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgZWxlbWVudC52YWx1ZS5sZW5ndGgpO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbmxpbmVFZGl0IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PGFueSxhbnk+IHtcbiAgICBzdGF0aWMgcHJvcFR5cGVzID0ge1xuICAgICAgICB0ZXh0OiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG4gICAgICAgIHBhcmFtTmFtZTogUHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxuICAgICAgICBjaGFuZ2U6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG4gICAgICAgIHBsYWNlaG9sZGVyOiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBjbGFzc05hbWU6IFByb3BUeXBlcy5zdHJpbmcsXG4gICAgICAgIGFjdGl2ZUNsYXNzTmFtZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgICAgbWluTGVuZ3RoOiBQcm9wVHlwZXMubnVtYmVyLFxuICAgICAgICBtYXhMZW5ndGg6IFByb3BUeXBlcy5udW1iZXIsXG4gICAgICAgIHZhbGlkYXRlOiBQcm9wVHlwZXMuZnVuYyxcbiAgICAgICAgc3R5bGU6IFByb3BUeXBlcy5vYmplY3QsXG4gICAgICAgIGVkaXRpbmdFbGVtZW50OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICBzdGF0aWNFbGVtZW50OiBQcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgICB0YWJJbmRleDogUHJvcFR5cGVzLm51bWJlcixcbiAgICAgICAgaXNEaXNhYmxlZDogUHJvcFR5cGVzLmJvb2wsXG4gICAgICAgIGVkaXRpbmc6IFByb3BUeXBlcy5ib29sXG4gICAgfTtcblxuICAgIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgICAgIG1pbkxlbmd0aDogMSxcbiAgICAgICAgbWF4TGVuZ3RoOiAyNTYsXG4gICAgICAgIGVkaXRpbmdFbGVtZW50OiAnaW5wdXQnLFxuICAgICAgICBzdGF0aWNFbGVtZW50OiAnc3BhbicsXG4gICAgICAgIHRhYkluZGV4OiAwLFxuICAgICAgICBpc0Rpc2FibGVkOiBmYWxzZSxcbiAgICAgICAgZWRpdGluZzogZmFsc2VcbiAgICB9O1xuXG4gICAgc3RhdGUgPSB7XG4gICAgICAgIGVkaXRpbmc6IHRoaXMucHJvcHMuZWRpdGluZyxcbiAgICAgICAgdGV4dDogdGhpcy5wcm9wcy50ZXh0LFxuICAgICAgICBtaW5MZW5ndGg6IHRoaXMucHJvcHMubWluTGVuZ3RoLFxuICAgICAgICBtYXhMZW5ndGg6IHRoaXMucHJvcHMubWF4TGVuZ3RoLFxuICAgIH07XG5cbiAgICBjb21wb25lbnRXaWxsTW91bnQoKSB7XG4gICAgICAgIHRoaXMuaXNJbnB1dFZhbGlkID0gdGhpcy5wcm9wcy52YWxpZGF0ZSB8fCB0aGlzLmlzSW5wdXRWYWxpZDtcbiAgICAgICAgLy8gV2FybiBhYm91dCBkZXByZWNhdGVkIGVsZW1lbnRzXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmVsZW1lbnQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybignYGVsZW1lbnRgIHByb3AgaXMgZGVwcmVjYXRlZDogaW5zdGVhZCBwYXNzIGVkaXRpbmdFbGVtZW50IG9yIHN0YXRpY0VsZW1lbnQgdG8gSW5saW5lRWRpdCBjb21wb25lbnQnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XG4gICAgICAgIGNvbnN0IGlzVGV4dENoYW5nZWQgPSAobmV4dFByb3BzLnRleHQgIT09IHRoaXMucHJvcHMudGV4dCk7XG4gICAgICAgIGNvbnN0IGlzRWRpdGluZ0NoYW5nZWQgPSAobmV4dFByb3BzLmVkaXRpbmcgIT09IHRoaXMucHJvcHMuZWRpdGluZyk7XG4gICAgICAgIGxldCBuZXh0U3RhdGU6YW55ID0ge307XG4gICAgICAgIGlmIChpc1RleHRDaGFuZ2VkKSB7XG4gICAgICAgICAgICBuZXh0U3RhdGUudGV4dCA9IG5leHRQcm9wcy50ZXh0O1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc0VkaXRpbmdDaGFuZ2VkKSB7XG4gICAgICAgICAgICBuZXh0U3RhdGUuZWRpdGluZyA9IG5leHRQcm9wcy5lZGl0aW5nO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc1RleHRDaGFuZ2VkIHx8IGlzRWRpdGluZ0NoYW5nZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUobmV4dFN0YXRlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbXBvbmVudERpZFVwZGF0ZShwcmV2UHJvcHMsIHByZXZTdGF0ZSkge1xuICAgICAgICBsZXQgaW5wdXRFbGVtID0gUmVhY3RET00uZmluZERPTU5vZGUodGhpcy5yZWZzLmlucHV0KTtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUuZWRpdGluZyAmJiAhcHJldlN0YXRlLmVkaXRpbmcpIHtcbiAgICAgICAgICAgIGlucHV0RWxlbS5mb2N1cygpO1xuICAgICAgICAgICAgc2VsZWN0SW5wdXRUZXh0KGlucHV0RWxlbSk7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5zdGF0ZS5lZGl0aW5nICYmIHByZXZQcm9wcy50ZXh0ICE9IHRoaXMucHJvcHMudGV4dCkge1xuICAgICAgICAgICAgdGhpcy5maW5pc2hFZGl0aW5nKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGFydEVkaXRpbmcgPSAoZSkgPT4ge1xuICAgICAgICBpZiAodGhpcy5wcm9wcy5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKClcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0YXRlKHtlZGl0aW5nOiB0cnVlLCB0ZXh0OiB0aGlzLnByb3BzLnRleHR9KTtcbiAgICB9O1xuXG4gICAgZmluaXNoRWRpdGluZyA9ICgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaXNJbnB1dFZhbGlkKHRoaXMuc3RhdGUudGV4dCkgJiYgdGhpcy5wcm9wcy50ZXh0ICE9IHRoaXMuc3RhdGUudGV4dCl7XG4gICAgICAgICAgICB0aGlzLmNvbW1pdEVkaXRpbmcoKTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnByb3BzLnRleHQgPT09IHRoaXMuc3RhdGUudGV4dCB8fCAhdGhpcy5pc0lucHV0VmFsaWQodGhpcy5zdGF0ZS50ZXh0KSkge1xuICAgICAgICAgICAgdGhpcy5jYW5jZWxFZGl0aW5nKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgY2FuY2VsRWRpdGluZyA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7ZWRpdGluZzogZmFsc2UsIHRleHQ6IHRoaXMucHJvcHMudGV4dH0pO1xuICAgIH07XG5cbiAgICBjb21taXRFZGl0aW5nID0gKCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtlZGl0aW5nOiBmYWxzZSwgdGV4dDogdGhpcy5zdGF0ZS50ZXh0fSk7XG4gICAgICAgIGxldCBuZXdQcm9wID0ge307XG4gICAgICAgIG5ld1Byb3BbdGhpcy5wcm9wcy5wYXJhbU5hbWVdID0gdGhpcy5zdGF0ZS50ZXh0O1xuICAgICAgICB0aGlzLnByb3BzLmNoYW5nZShuZXdQcm9wKTtcbiAgICB9O1xuXG4gICAgY2xpY2tXaGVuRWRpdGluZyA9IChlKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnN0b3BQcm9wYWdhdGlvbikge1xuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICBpc0lucHV0VmFsaWQgPSAodGV4dCkgPT4ge1xuICAgICAgICByZXR1cm4gKHRleHQubGVuZ3RoID49IHRoaXMuc3RhdGUubWluTGVuZ3RoICYmIHRleHQubGVuZ3RoIDw9IHRoaXMuc3RhdGUubWF4TGVuZ3RoKTtcbiAgICB9O1xuXG4gICAga2V5RG93biA9IChldmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgICAgICAgIHRoaXMuZmluaXNoRWRpdGluZygpO1xuICAgICAgICB9IGVsc2UgaWYgKGV2ZW50LmtleUNvZGUgPT09IDI3KSB7XG4gICAgICAgICAgICB0aGlzLmNhbmNlbEVkaXRpbmcoKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0ZXh0Q2hhbmdlZCA9IChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgICAgIHRleHQ6IGV2ZW50LnRhcmdldC52YWx1ZS50cmltKClcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuaXNEaXNhYmxlZCkge1xuICAgICAgICAgIGNvbnN0IEVsZW1lbnQgPSB0aGlzLnByb3BzLmVsZW1lbnQgfHwgdGhpcy5wcm9wcy5zdGF0aWNFbGVtZW50O1xuICAgICAgICAgIHJldHVybiA8RWxlbWVudFxuICAgICAgICAgICAgICBjbGFzc05hbWU9e3RoaXMucHJvcHMuY2xhc3NOYW1lfVxuICAgICAgICAgICAgICBzdHlsZT17dGhpcy5wcm9wcy5zdHlsZX0gPlxuICAgICAgICAgICAgICB7dGhpcy5zdGF0ZS50ZXh0IHx8IHRoaXMucHJvcHMucGxhY2Vob2xkZXJ9XG4gICAgICAgICAgPC9FbGVtZW50PjtcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5zdGF0ZS5lZGl0aW5nKSB7XG4gICAgICAgICAgICBjb25zdCBFbGVtZW50ID0gdGhpcy5wcm9wcy5lbGVtZW50IHx8IHRoaXMucHJvcHMuc3RhdGljRWxlbWVudDtcbiAgICAgICAgICAgIHJldHVybiA8RWxlbWVudFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17dGhpcy5wcm9wcy5jbGFzc05hbWV9XG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5zdGFydEVkaXRpbmd9XG4gICAgICAgICAgICAgICAgdGFiSW5kZXg9e3RoaXMucHJvcHMudGFiSW5kZXh9XG4gICAgICAgICAgICAgICAgc3R5bGU9e3RoaXMucHJvcHMuc3R5bGV9ID5cbiAgICAgICAgICAgICAgICB7dGhpcy5zdGF0ZS50ZXh0IHx8IHRoaXMucHJvcHMucGxhY2Vob2xkZXJ9XG4gICAgICAgICAgICA8L0VsZW1lbnQ+O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgRWxlbWVudCA9IHRoaXMucHJvcHMuZWxlbWVudCB8fCB0aGlzLnByb3BzLmVkaXRpbmdFbGVtZW50O1xuICAgICAgICAgICAgcmV0dXJuIDxFbGVtZW50XG4gICAgICAgICAgICAgICAgb25DbGljaz17dGhpcy5jbGlja1doZW5FZGl0aW5nfVxuICAgICAgICAgICAgICAgIG9uS2V5RG93bj17dGhpcy5rZXlEb3dufVxuICAgICAgICAgICAgICAgIG9uQmx1cj17dGhpcy5maW5pc2hFZGl0aW5nfVxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17dGhpcy5wcm9wcy5hY3RpdmVDbGFzc05hbWV9XG4gICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9e3RoaXMucHJvcHMucGxhY2Vob2xkZXJ9XG4gICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlPXt0aGlzLnN0YXRlLnRleHR9XG4gICAgICAgICAgICAgICAgb25DaGFuZ2U9e3RoaXMudGV4dENoYW5nZWR9XG4gICAgICAgICAgICAgICAgc3R5bGU9e3RoaXMucHJvcHMuc3R5bGV9XG4gICAgICAgICAgICAgICAgcmVmPVwiaW5wdXRcIiAvPjtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==