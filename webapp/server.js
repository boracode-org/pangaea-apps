"use strict";
//DATABASE_URL
Object.defineProperty(exports, "__esModule", { value: true });
// add route to show this database url env
const express = require("express");
const next = require("next");
const path = require("path");
const fs = require("fs");
const port = parseInt(process.env.PORT, 10);
const dev = process.env.NODE_ENV !== "production";
const nextApp = next({ dev });
const Constants_1 = require("./Constants");
var ParseDashboard = require("parse-dashboard");
var ParseServer = require("parse-server").ParseServer;
const StaticFileSystemAdapter_1 = require("./StaticFileSystemAdapter");
const uploadFolder = path.resolve(Constants_1.CONSTANTS.UPLOAD_FOLDER); // + "/../files/uploads");
const handle = nextApp.getRequestHandler();
nextApp.prepare().then(() => {
    const app = express();
    // // Hide this, could be security risk
    // app.disable("x-powered-by");
    // //Apply CORS
    // app.use(function(req, res, next) {
    //   res.header("Access-Control-Allow-Origin", "*");
    //   res.header(
    //     "Access-Control-Allow-Headers",
    //     "Origin, X-Requested-With, Content-Type, Accept"
    //   );
    //   next();
    // });
    var allowInsecureHTTP = true;
    var dashboard = new ParseDashboard({
        apps: [
            {
                serverURL: Constants_1.CONSTANTS.SERVER_URL,
                appId: Constants_1.CONSTANTS.APP_ID,
                masterKey: Constants_1.CONSTANTS.MASTER_KEY,
                appName: Constants_1.CONSTANTS.APP_NAME
            }
        ],
        users: [
            {
                user: "ronald.adonyo@gmail.com",
                pass: "adonyo123"
            }
        ],
        trustProxy: 1
    }, allowInsecureHTTP);
    var fsAdapter = new StaticFileSystemAdapter_1.default({
        filesSubDirectory: Constants_1.CONSTANTS.UPLOAD_FOLDER // optional
    });
    var parse = new ParseServer({
        databaseURI: Constants_1.CONSTANTS.DATABASE_URI,
        cloud: "cloud/main.js",
        appId: Constants_1.CONSTANTS.APP_ID,
        masterKey: Constants_1.CONSTANTS.MASTER_KEY,
        fileKey: "optionalFileKey",
        serverURL: "http://localhost:" + process.env.PORT + "/parse",
        // filesAdapter: {
        //   module: "parse-server-fs-adapter",
        //   options: {
        //     filesSubDirectory: CONSTANTS.UPLOAD_FOLDER // optional
        //   }
        // },
        filesAdapter: fsAdapter,
        maxUploadSize: "5000mb",
        liveQuery: {
            classNames: ["Devices", "Media", "Settings", "Snapshots", "TimeSlots"]
        },
        startLiveQueryServer: true
    });
    // Serve the Parse API on the /parse URL prefix
    app.use("/parse", parse);
    // make the Parse Dashboard available at /dashboard
    app.use("/dashboard", dashboard);
    app.get("/videoIOS", (req, res) => {
        var { filename } = req.query;
        var saveTo = path.join(uploadFolder, path.basename(filename));
        var filePath = path.join(uploadFolder, filename);
        var file = filePath; ///path.resolve(__dirname, "movie.mp4");
        fs.stat(file, function (err, stats) {
            if (err) {
                if (err.code === "ENOENT") {
                    // 404 Error if file not found
                    return res.sendStatus(404);
                }
                res.end(err);
            }
            var total = stats.size;
            var range = req.headers.range;
            if (!range) {
                // 416 Wrong range
                // return res.sendStatus(416);
                console.log("ALL: " + total);
                res.writeHead(200, {
                    "Content-Length": total,
                    "Content-Type": "video/mp4"
                });
                return fs.createReadStream(file).pipe(res);
            }
            var positions = range.replace(/bytes=/, "").split("-");
            var start = parseInt(positions[0], 10);
            var end = positions[1] ? parseInt(positions[1], 10) : total - 1;
            var chunksize = end - start + 1;
            res.writeHead(206, {
                "Content-Range": "bytes " + start + "-" + end + "/" + total,
                "Accept-Ranges": "bytes",
                "Content-Length": chunksize,
                "Content-Type": "video/mp4"
            });
            var stream = fs
                .createReadStream(file, { start: start, end: end })
                .on("open", function () {
                stream.pipe(res);
            })
                .on("error", function (err) {
                res.end(err);
            });
        });
    });
    app.get("/status", (req, res) => {
        return res.json({
            PORT: port,
            DATABASE_URL: process.env.DATABASE_URL
        });
    });
    //   server.get('/a', (req, res) => {
    //     return app.render(req, res, '/b', req.query)
    //   })
    //   server.get('/b', (req, res) => {
    //     return app.render(req, res, '/a', req.query)
    //   })
    //   server.get('/posts/:id', (req, res) => {
    //     return app.render(req, res, '/posts', { id: req.params.id })
    //   })
    app.get("*", (req, res) => {
        return handle(req, res);
    });
    // Initialize a LiveQuery server instance, app is the express app of your Parse Server
    var httpServer = require("http").createServer(app);
    // httpServer.listen(port, err => {
    //   if (err) throw err;
    //   console.log(`> Ready on http://localhost:${port}`);
    //   // Live Query server started...
    // });
    httpServer.listen(port, err => {
        if (err)
            throw err;
        console.log(`> Ready on http://localhost:${port}`);
        // Live Query server started...
    });
    // var parseLiveQueryServer = ParseServer.createLiveQueryServer(null, {
    //   appId: CONSTANTS.APP_ID,
    //   masterKey: CONSTANTS.MASTER_KEY,
    //   serverURL: `http://localhost:${port}/parse`,
    //   port:8000,
    //   host:"0.0.0.0"
    //   // redisURL: 'redis://localhost:6379'
    // });
    global["httpServer"] = httpServer;
    global["ParseServer"] = ParseServer;
    var parseLiveQueryServer = global["ParseServer"].createLiveQueryServer(global["httpServer"]);
    console.log(parseLiveQueryServer);
    // parseLiveQueryServer.
    /*, {
      appId: 'appId',
      masterKey: 'masterKey',
      serverURL: 'http://localhost:4000/parse',
      // redisURL: 'redis://localhost:6379'
    });*/
    // console.log("live query ..", parseLiveQueryServer);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsic2VydmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxjQUFjOztBQUVkLDBDQUEwQztBQUUxQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbkMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzdCLDZCQUE2QjtBQUM3Qix5QkFBeUI7QUFFekIsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxLQUFLLFlBQVksQ0FBQztBQUNsRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0FBRzlCLDJDQUE4QztBQUM5QyxJQUFJLGNBQWMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUNoRCxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUMsV0FBVyxDQUFDO0FBRXRELHVFQUFnRTtBQUVoRSxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLHFCQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQywwQkFBMEI7QUFFdEYsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFFM0MsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7SUFDMUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxFQUFFLENBQUM7SUFFdEIsdUNBQXVDO0lBQ3ZDLCtCQUErQjtJQUUvQixlQUFlO0lBQ2YscUNBQXFDO0lBQ3JDLG9EQUFvRDtJQUNwRCxnQkFBZ0I7SUFDaEIsc0NBQXNDO0lBQ3RDLHVEQUF1RDtJQUN2RCxPQUFPO0lBQ1AsWUFBWTtJQUNa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RyxDQUFDO1lBQUMsTUFBTSxHQUFHLENBQUM7UUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQkFBK0IsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUVuRCwrQkFBK0I7SUFDakMsQ0FBQyxDQUFDLENBQUM7SUFDSCx1RUFBdUU7SUFDdkUsNkJBQTZCO0lBQzdCLHFDQUFxQztJQUNyQyxpREFBaUQ7SUFDakQsZUFBZTtJQUNmLG1CQUFtQjtJQUNuQiwwQ0FBMEM7SUFDMUMsTUFBTTtJQUVOLE1BQU0sQ0FBQyxZQUFZLENBQUMsR0FBRyxVQUFVLENBQUM7SUFDbEMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxHQUFHLFdBQVcsQ0FBQztJQUVwQyxJQUFJLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxxQkFBcUIsQ0FDcEUsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUNyQixDQUFDO0lBQ0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0lBQ2xDLHdCQUF3QjtJQUN4Qjs7Ozs7U0FLSztJQUNMLHNEQUFzRDtBQUN4RCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vREFUQUJBU0VfVVJMXG5cbi8vIGFkZCByb3V0ZSB0byBzaG93IHRoaXMgZGF0YWJhc2UgdXJsIGVudlxuXG5jb25zdCBleHByZXNzID0gcmVxdWlyZShcImV4cHJlc3NcIik7XG5jb25zdCBuZXh0ID0gcmVxdWlyZShcIm5leHRcIik7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuY29uc3QgcG9ydCA9IHBhcnNlSW50KHByb2Nlc3MuZW52LlBPUlQsIDEwKTtcbmNvbnN0IGRldiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSBcInByb2R1Y3Rpb25cIjtcbmNvbnN0IG5leHRBcHAgPSBuZXh0KHsgZGV2IH0pO1xuXG5pbXBvcnQgeyBlbmFibGVWaWRlb0FwaSB9IGZyb20gXCIuL3ZpZGVvQXBpXCI7XG5pbXBvcnQgeyBDT05TVEFOVFMsIFBPUlQgfSBmcm9tIFwiLi9Db25zdGFudHNcIjtcbnZhciBQYXJzZURhc2hib2FyZCA9IHJlcXVpcmUoXCJwYXJzZS1kYXNoYm9hcmRcIik7XG52YXIgUGFyc2VTZXJ2ZXIgPSByZXF1aXJlKFwicGFyc2Utc2VydmVyXCIpLlBhcnNlU2VydmVyO1xuXG5pbXBvcnQgU3RhdGljRmlsZVN5c3RlbUFkYXB0ZXIgZnJvbSBcIi4vU3RhdGljRmlsZVN5c3RlbUFkYXB0ZXJcIjtcblxuY29uc3QgdXBsb2FkRm9sZGVyID0gcGF0aC5yZXNvbHZlKENPTlNUQU5UUy5VUExPQURfRk9MREVSKTsgLy8gKyBcIi8uLi9maWxlcy91cGxvYWRzXCIpO1xuXG5jb25zdCBoYW5kbGUgPSBuZXh0QXBwLmdldFJlcXVlc3RIYW5kbGVyKCk7XG5cbm5leHRBcHAucHJlcGFyZSgpLnRoZW4oKCkgPT4ge1xuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG5cbiAgLy8gLy8gSGlkZSB0aGlzLCBjb3VsZCBiZSBzZWN1cml0eSByaXNrXG4gIC8vIGFwcC5kaXNhYmxlKFwieC1wb3dlcmVkLWJ5XCIpO1xuXG4gIC8vIC8vQXBwbHkgQ09SU1xuICAvLyBhcHAudXNlKGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gIC8vICAgcmVzLmhlYWRlcihcIkFjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpblwiLCBcIipcIik7XG4gIC8vICAgcmVzLmhlYWRlcihcbiAgLy8gICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiLFxuICAvLyAgICAgXCJPcmlnaW4sIFgtUmVxdWVzdGVkLVdpdGgsIENvbnRlbnQtVHlwZSwgQWNjZXB0XCJcbiAgLy8gICApO1xuICAvLyAgIG5leHQoKTtcbiAgLy8gfSk7XG5cbiAgdmFyIGFsbG93SW5zZWN1cmVIVFRQID0gdHJ1ZTtcblxuICB2YXIgZGFzaGJvYXJkID0gbmV3IFBhcnNlRGFzaGJvYXJkKFxuICAgIHtcbiAgICAgIGFwcHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIHNlcnZlclVSTDogQ09OU1RBTlRTLlNFUlZFUl9VUkwsXG4gICAgICAgICAgYXBwSWQ6IENPTlNUQU5UUy5BUFBfSUQsXG4gICAgICAgICAgbWFzdGVyS2V5OiBDT05TVEFOVFMuTUFTVEVSX0tFWSxcbiAgICAgICAgICBhcHBOYW1lOiBDT05TVEFOVFMuQVBQX05BTUVcbiAgICAgICAgfVxuICAgICAgXSxcbiAgICAgIHVzZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyOiBcInJvbmFsZC5hZG9ueW9AZ21haWwuY29tXCIsXG4gICAgICAgICAgcGFzczogXCJhZG9ueW8xMjNcIlxuICAgICAgICB9XG4gICAgICBdLFxuICAgICAgdHJ1c3RQcm94eTogMVxuICAgIH0sXG4gICAgYWxsb3dJbnNlY3VyZUhUVFBcbiAgKTtcblxuICB2YXIgZnNBZGFwdGVyID0gbmV3IFN0YXRpY0ZpbGVTeXN0ZW1BZGFwdGVyKHtcbiAgICBmaWxlc1N1YkRpcmVjdG9yeTogQ09OU1RBTlRTLlVQTE9BRF9GT0xERVIgLy8gb3B0aW9uYWxcbiAgfSk7XG5cbiAgdmFyIHBhcnNlID0gbmV3IFBhcnNlU2VydmVyKHtcbiAgICBkYXRhYmFzZVVSSTogQ09OU1RBTlRTLkRBVEFCQVNFX1VSSSwgLy8gQ29ubmVjdGlvbiBzdHJpbmcgZm9yIHlvdXIgTW9uZ29EQiBkYXRhYmFzZVxuICAgIGNsb3VkOiBcImNsb3VkL21haW4uanNcIiwgLy8gQWJzb2x1dGUgcGF0aCB0byB5b3VyIENsb3VkIENvZGVcbiAgICBhcHBJZDogQ09OU1RBTlRTLkFQUF9JRCxcbiAgICBtYXN0ZXJLZXk6IENPTlNUQU5UUy5NQVNURVJfS0VZLCAvLyBLZWVwIHRoaXMga2V5IHNlY3JldCFcbiAgICBmaWxlS2V5OiBcIm9wdGlvbmFsRmlsZUtleVwiLFxuICAgIHNlcnZlclVSTDogXCJodHRwOi8vbG9jYWxob3N0OlwiICsgcHJvY2Vzcy5lbnYuUE9SVCArIFwiL3BhcnNlXCIsIC8vQ09OU1RBTlRTLlNFUlZFUl9VUkwsIC8vIERvbid0IGZvcmdldCB0byBjaGFuZ2UgdG8gaHR0cHMgaWYgbmVlZGVkLFxuICAgIC8vIGZpbGVzQWRhcHRlcjoge1xuICAgIC8vICAgbW9kdWxlOiBcInBhcnNlLXNlcnZlci1mcy1hZGFwdGVyXCIsXG4gICAgLy8gICBvcHRpb25zOiB7XG4gICAgLy8gICAgIGZpbGVzU3ViRGlyZWN0b3J5OiBDT05TVEFOVFMuVVBMT0FEX0ZPTERFUiAvLyBvcHRpb25hbFxuICAgIC8vICAgfVxuICAgIC8vIH0sXG5cbiAgICBmaWxlc0FkYXB0ZXI6IGZzQWRhcHRlcixcbiAgICBtYXhVcGxvYWRTaXplOiBcIjUwMDBtYlwiLFxuICAgIGxpdmVRdWVyeToge1xuICAgICAgY2xhc3NOYW1lczogW1wiRGV2aWNlc1wiLCBcIk1lZGlhXCIsIFwiU2V0dGluZ3NcIiwgXCJTbmFwc2hvdHNcIiwgXCJUaW1lU2xvdHNcIl1cbiAgICB9LFxuICAgIHN0YXJ0TGl2ZVF1ZXJ5U2VydmVyOiB0cnVlXG4gIH0pO1xuXG4gIC8vIFNlcnZlIHRoZSBQYXJzZSBBUEkgb24gdGhlIC9wYXJzZSBVUkwgcHJlZml4XG4gIGFwcC51c2UoXCIvcGFyc2VcIiwgcGFyc2UpO1xuXG4gIC8vIG1ha2UgdGhlIFBhcnNlIERhc2hib2FyZCBhdmFpbGFibGUgYXQgL2Rhc2hib2FyZFxuICBhcHAudXNlKFwiL2Rhc2hib2FyZFwiLCBkYXNoYm9hcmQpO1xuXG4gIGFwcC5nZXQoXCIvdmlkZW9JT1NcIiwgKHJlcSwgcmVzKSA9PiB7XG4gICAgdmFyIHsgZmlsZW5hbWUgfSA9IHJlcS5xdWVyeTtcbiAgICB2YXIgc2F2ZVRvID0gcGF0aC5qb2luKHVwbG9hZEZvbGRlciwgcGF0aC5iYXNlbmFtZShmaWxlbmFtZSkpO1xuICAgIHZhciBmaWxlUGF0aCA9IHBhdGguam9pbih1cGxvYWRGb2xkZXIsIGZpbGVuYW1lKTtcbiAgICB2YXIgZmlsZSA9IGZpbGVQYXRoOyAvLy9wYXRoLnJlc29sdmUoX19kaXJuYW1lLCBcIm1vdmllLm1wNFwiKTtcbiAgICBmcy5zdGF0KGZpbGUsIGZ1bmN0aW9uKGVyciwgc3RhdHMpIHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgaWYgKGVyci5jb2RlID09PSBcIkVOT0VOVFwiKSB7XG4gICAgICAgICAgLy8gNDA0IEVycm9yIGlmIGZpbGUgbm90IGZvdW5kXG4gICAgICAgICAgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwNCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzLmVuZChlcnIpO1xuICAgICAgfVxuICAgICAgdmFyIHRvdGFsID0gc3RhdHMuc2l6ZTtcbiAgICAgIHZhciByYW5nZSA9IHJlcS5oZWFkZXJzLnJhbmdlO1xuICAgICAgaWYgKCFyYW5nZSkge1xuICAgICAgICAvLyA0MTYgV3JvbmcgcmFuZ2VcbiAgICAgICAgLy8gcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQxNik7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiQUxMOiBcIiArIHRvdGFsKTtcbiAgICAgICAgcmVzLndyaXRlSGVhZCgyMDAsIHtcbiAgICAgICAgICBcIkNvbnRlbnQtTGVuZ3RoXCI6IHRvdGFsLFxuICAgICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwidmlkZW8vbXA0XCJcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGUpLnBpcGUocmVzKTtcbiAgICAgIH1cbiAgICAgIHZhciBwb3NpdGlvbnMgPSByYW5nZS5yZXBsYWNlKC9ieXRlcz0vLCBcIlwiKS5zcGxpdChcIi1cIik7XG4gICAgICB2YXIgc3RhcnQgPSBwYXJzZUludChwb3NpdGlvbnNbMF0sIDEwKTtcblxuICAgICAgdmFyIGVuZCA9IHBvc2l0aW9uc1sxXSA/IHBhcnNlSW50KHBvc2l0aW9uc1sxXSwgMTApIDogdG90YWwgLSAxO1xuICAgICAgdmFyIGNodW5rc2l6ZSA9IGVuZCAtIHN0YXJ0ICsgMTtcblxuICAgICAgcmVzLndyaXRlSGVhZCgyMDYsIHtcbiAgICAgICAgXCJDb250ZW50LVJhbmdlXCI6IFwiYnl0ZXMgXCIgKyBzdGFydCArIFwiLVwiICsgZW5kICsgXCIvXCIgKyB0b3RhbCxcbiAgICAgICAgXCJBY2NlcHQtUmFuZ2VzXCI6IFwiYnl0ZXNcIixcbiAgICAgICAgXCJDb250ZW50LUxlbmd0aFwiOiBjaHVua3NpemUsXG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwidmlkZW8vbXA0XCJcbiAgICAgIH0pO1xuXG4gICAgICB2YXIgc3RyZWFtID0gZnNcbiAgICAgICAgLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZSwgeyBzdGFydDogc3RhcnQsIGVuZDogZW5kIH0pXG4gICAgICAgIC5vbihcIm9wZW5cIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgc3RyZWFtLnBpcGUocmVzKTtcbiAgICAgICAgfSlcbiAgICAgICAgLm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICAgICAgcmVzLmVuZChlcnIpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgYXBwLmdldChcIi9zdGF0dXNcIiwgKHJlcSwgcmVzKSA9PiB7XG4gICAgcmV0dXJuIHJlcy5qc29uKHtcbiAgICAgIFBPUlQ6IHBvcnQsXG4gICAgICBEQVRBQkFTRV9VUkw6IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTFxuICAgIH0pO1xuICB9KTtcblxuICAvLyAgIHNlcnZlci5nZXQoJy9hJywgKHJlcSwgcmVzKSA9PiB7XG4gIC8vICAgICByZXR1cm4gYXBwLnJlbmRlcihyZXEsIHJlcywgJy9iJywgcmVxLnF1ZXJ5KVxuICAvLyAgIH0pXG5cbiAgLy8gICBzZXJ2ZXIuZ2V0KCcvYicsIChyZXEsIHJlcykgPT4ge1xuICAvLyAgICAgcmV0dXJuIGFwcC5yZW5kZXIocmVxLCByZXMsICcvYScsIHJlcS5xdWVyeSlcbiAgLy8gICB9KVxuXG4gIC8vICAgc2VydmVyLmdldCgnL3Bvc3RzLzppZCcsIChyZXEsIHJlcykgPT4ge1xuICAvLyAgICAgcmV0dXJuIGFwcC5yZW5kZXIocmVxLCByZXMsICcvcG9zdHMnLCB7IGlkOiByZXEucGFyYW1zLmlkIH0pXG4gIC8vICAgfSlcblxuICBhcHAuZ2V0KFwiKlwiLCAocmVxLCByZXMpID0+IHtcbiAgICByZXR1cm4gaGFuZGxlKHJlcSwgcmVzKTtcbiAgfSk7XG5cbiAgLy8gSW5pdGlhbGl6ZSBhIExpdmVRdWVyeSBzZXJ2ZXIgaW5zdGFuY2UsIGFwcCBpcyB0aGUgZXhwcmVzcyBhcHAgb2YgeW91ciBQYXJzZSBTZXJ2ZXJcblxuICB2YXIgaHR0cFNlcnZlciA9IHJlcXVpcmUoXCJodHRwXCIpLmNyZWF0ZVNlcnZlcihhcHApO1xuICAvLyBodHRwU2VydmVyLmxpc3Rlbihwb3J0LCBlcnIgPT4ge1xuICAvLyAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgLy8gICBjb25zb2xlLmxvZyhgPiBSZWFkeSBvbiBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gKTtcbiAgLy8gICAvLyBMaXZlIFF1ZXJ5IHNlcnZlciBzdGFydGVkLi4uXG4gIC8vIH0pO1xuXG4gIGh0dHBTZXJ2ZXIubGlzdGVuKHBvcnQsIGVyciA9PiB7XG4gICAgaWYgKGVycikgdGhyb3cgZXJyO1xuICAgIGNvbnNvbGUubG9nKGA+IFJlYWR5IG9uIGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fWApO1xuXG4gICAgLy8gTGl2ZSBRdWVyeSBzZXJ2ZXIgc3RhcnRlZC4uLlxuICB9KTtcbiAgLy8gdmFyIHBhcnNlTGl2ZVF1ZXJ5U2VydmVyID0gUGFyc2VTZXJ2ZXIuY3JlYXRlTGl2ZVF1ZXJ5U2VydmVyKG51bGwsIHtcbiAgLy8gICBhcHBJZDogQ09OU1RBTlRTLkFQUF9JRCxcbiAgLy8gICBtYXN0ZXJLZXk6IENPTlNUQU5UUy5NQVNURVJfS0VZLFxuICAvLyAgIHNlcnZlclVSTDogYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9wYXJzZWAsXG4gIC8vICAgcG9ydDo4MDAwLFxuICAvLyAgIGhvc3Q6XCIwLjAuMC4wXCJcbiAgLy8gICAvLyByZWRpc1VSTDogJ3JlZGlzOi8vbG9jYWxob3N0OjYzNzknXG4gIC8vIH0pO1xuXG4gIGdsb2JhbFtcImh0dHBTZXJ2ZXJcIl0gPSBodHRwU2VydmVyO1xuICBnbG9iYWxbXCJQYXJzZVNlcnZlclwiXSA9IFBhcnNlU2VydmVyO1xuXG4gIHZhciBwYXJzZUxpdmVRdWVyeVNlcnZlciA9IGdsb2JhbFtcIlBhcnNlU2VydmVyXCJdLmNyZWF0ZUxpdmVRdWVyeVNlcnZlcihcbiAgICBnbG9iYWxbXCJodHRwU2VydmVyXCJdXG4gICk7XG4gIGNvbnNvbGUubG9nKHBhcnNlTGl2ZVF1ZXJ5U2VydmVyKTtcbiAgLy8gcGFyc2VMaXZlUXVlcnlTZXJ2ZXIuXG4gIC8qLCB7XG4gICAgYXBwSWQ6ICdhcHBJZCcsXG4gICAgbWFzdGVyS2V5OiAnbWFzdGVyS2V5JyxcbiAgICBzZXJ2ZXJVUkw6ICdodHRwOi8vbG9jYWxob3N0OjQwMDAvcGFyc2UnLFxuICAgIC8vIHJlZGlzVVJMOiAncmVkaXM6Ly9sb2NhbGhvc3Q6NjM3OSdcbiAgfSk7Ki9cbiAgLy8gY29uc29sZS5sb2coXCJsaXZlIHF1ZXJ5IC4uXCIsIHBhcnNlTGl2ZVF1ZXJ5U2VydmVyKTtcbn0pO1xuIl19